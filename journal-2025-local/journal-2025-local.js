(()=>{function k(){window.onscroll=()=>{let e=[[document.getElementById("page-header"),"sticky-shadow-header"],[document.getElementById("page-footer"),"sticky-shadow-footer"]],r=document.body.scrollTop>0||document.documentElement.scrollTop>0;e.forEach(([n,t])=>n.classList[r?"add":"remove"](t))}}function D(){let r="JOURNAL-2025-theme",n=document.querySelector(".theme-toggler"),t=document.querySelector(".light"),o=document.querySelector(".dark"),i=n.querySelector(".light .visually-hidden"),s=n.querySelector(".dark .visually-hidden"),d=n.querySelector("button");function l(){try{let f=localStorage.getItem(r);return f?JSON.parse(f):!1}catch(f){return console.error("Error parsing theme from localStorage:",f),!1}}let a=l();function c(f){a=f,document.documentElement.classList.toggle("darkmode",a),localStorage.setItem(r,a),m()}function u(){c(!a)}function m(){i.textContent=a?" theme inactive":" theme active",s.textContent=a?" theme active":" theme inactive";let f=i.textContent,y=s.textContent;A(f,t),A(y,o),d.setAttribute("aria-pressed",a?"false":"true")}function A(f,y){f===" theme active"?y.classList.add("underline"):y.classList.remove("underline")}d.addEventListener("click",u),c(a)}function F(){let e=document.getElementById("loader"),r=document.getElementById("page-loaded");window.addEventListener("load",()=>{r.textContent="Page has loaded.",requestAnimationFrame(()=>{e.classList.add("loader-hidden")})})}function Q(e="Working\u2026"){let r=document.getElementById("loader"),n=document.getElementById("page-loaded");if(!r)return;let t=r.querySelector(".visually-hidden");t&&(t.textContent=e),n&&(n.textContent=e),r.classList.remove("loader-hidden")}function O(e="Done."){let r=document.getElementById("loader"),n=document.getElementById("page-loaded");if(!r)return;let t=r.querySelector(".visually-hidden");t&&(t.textContent=e),n&&(n.textContent=e),requestAnimationFrame(()=>{r.classList.add("loader-hidden")})}function R(){let e=document.querySelector("html"),r=document.querySelector(".header");new ResizeObserver(t=>{for(let o of t){let i=getComputedStyle(o.target),s=getComputedStyle(e),d=parseFloat(i.paddingBlockStart),l=parseFloat(i.paddingBlockEnd),a=d+l,c=parseFloat(s.getPropertyValue("--skip-link-gap"))||0,u=a+c,m=(o.contentRect.height+u)/16;e.style=`scroll-padding-top: ${m}rem`}}).observe(r)}function g(e,r){for(let[n,t]of Object.entries(r))t==null?e.removeAttribute(n):e.setAttribute(n,t)}var ee="Enter a title...",te="Enter some text...",re="Enter alt text...";function q(e,r,n){e.getAttribute("placeholder")===""&&e.setAttribute("placeholder",ee),r.getAttribute("placeholder")===""&&r.setAttribute("placeholder",te),n&&n.getAttribute("placeholder")===""&&n.setAttribute("placeholder",re)}function S(e,r,n){e.setAttribute("required",""),r.setAttribute("required",""),n.setAttribute("required","")}function Y(e,r){e.date.value=r,e.heading.value="",e.text.value="",e.image.input.value="",e.image.altText.value="",e.image.wrapper.classList.add("hide")}function V(e){e.charCounter.textContent="0/150",e.charLimit.textContent="",e.cancelButton.setAttribute("disabled","")}function w(e,r){Y(e,r),V(e.image),e.form.classList.add("hide"),e.buttons.create.removeAttribute("disabled")}function N(e){e.wrapper.classList.remove("hide"),e.cancelButton.removeAttribute("disabled")}function U(e){e.input.value="",e.wrapper.classList.add("hide"),e.altText.value="",e.charCounter.textContent="0/150",e.charLimit.textContent="",e.cancelButton.setAttribute("disabled","")}function H(e,r,n){let t=e.value.length;r.textContent=`${t}/150`,n.textContent=t===150?"No more characters allowed!":""}function X(e){let r=e?.name||"",n=e?.message||"";if(r==="QuotaExceededError"||r==="NS_ERROR_DOM_QUOTA_REACHED"||n.includes("QUOTA")||n.includes("disk is full")){alert(`
Your browser's storage is full.

Try:
\u2022 Deleting large images
\u2022 Removing older entries
\u2022 Exporting entries to JSON, then clearing the journal

(IndexedDB does not have unlimited space on your device.)
    `);return}console.error(e),alert("A storage error occurred. See console for details.")}async function x(e){try{return await e()}catch(r){throw X(r),r}}var ne="journal2025local",p="entries",oe=1,L;function T(){return new Promise((e,r)=>{if(L)return e(L);let n=indexedDB.open(ne,oe);n.onerror=()=>r(n.error),n.onsuccess=()=>{L=n.result,e(L)},n.onupgradeneeded=t=>{let o=t.target.result;o.objectStoreNames.contains(p)||o.createObjectStore(p,{keyPath:"id"})}})}function P(e){return x(async()=>{let n=(await T()).transaction(p,"readwrite");return n.objectStore(p).put(e),new Promise((t,o)=>{n.oncomplete=()=>t(),n.onerror=()=>o(n.error)})})}function b(){return x(async()=>{let t=(await T()).transaction(p,"readonly").objectStore(p).getAll();return new Promise((o,i)=>{t.onsuccess=()=>o(t.result),t.onerror=()=>i(t.error)})})}function B(e){return P(e)}function K(e){return x(async()=>{let n=(await T()).transaction(p,"readwrite");return n.objectStore(p).delete(e),new Promise((t,o)=>{n.oncomplete=()=>t(),n.onerror=()=>o(n.error)})})}function Z(){return x(async()=>{let r=(await T()).transaction(p,"readwrite");return r.objectStore(p).clear(),new Promise((n,t)=>{r.oncomplete=()=>n(),r.onerror=()=>t(r.error)})})}function J({addEntry:e,updateExportButton:r}={}){let n=new Date().toISOString().split("T")[0],t={form:document.getElementById("journal-form"),heading:document.getElementById("journal-heading"),text:document.getElementById("journal-text"),date:document.getElementById("journal-entry-date"),image:{input:document.getElementById("image-input"),wrapper:document.getElementById("alt-text-wrapper"),altText:document.getElementById("image-alt"),charCounter:document.getElementById("character-count"),charLimit:document.getElementById("character-limit-message"),cancelButton:document.querySelector("[data-cancel-image-upload-button]"),fileBlob:null,fileType:null},buttons:{create:document.getElementById("create-entry"),cancel:document.getElementById("cancel")}};t.date.value=n,t.image.altText.value="",t.image.altText.addEventListener("input",()=>{H(t.image.altText,t.image.charCounter,t.image.charLimit)}),t.buttons.create.addEventListener("click",o=>{o.target.setAttribute("disabled","true"),t.form.classList.remove("hide"),g(t.form,{role:"region",tabindex:"-1","aria-label":"Journal entry form"}),t.form.focus(),t.form.classList.add("focus-highlight"),setTimeout(()=>{t.form.classList.remove("focus-highlight"),g(t.form,{role:null,tabindex:null,"aria-label":null})},2e3),S(t.date,t.heading,t.text)}),t.buttons.cancel.addEventListener("click",()=>{w(t,n),t.image.fileBlob=null,t.image.fileType=null}),t.image.input.addEventListener("change",o=>{if(o.target.files&&o.target.files.length>0){let i=o.target.files[0];t.image.fileBlob=i,t.image.fileType=i.type,N(t.image)}}),t.image.cancelButton.addEventListener("click",()=>{U(t.image),t.image.fileBlob=null,t.image.fileType=null}),t.form.addEventListener("submit",async o=>{o.preventDefault(),q(t.heading,t.text,t.image.altText);let i={date:t.date.value.split("-").reverse().join("/"),heading:t.heading.value,text:t.text.value,edited:!1,id:new Date().valueOf().toString(),imageAlt:t.image.altText.value||"",imageBlob:t.image.fileBlob||null,imageType:t.image.fileType||null};try{await P(i)}catch(s){console.error("Failed to save entry to IndexedDB",s)}e(i),r&&r(),w(t,n),t.image.fileBlob=null,t.image.fileType=null})}function M(e){e.addEventListener("keydown",r=>{if(r.key!=="Enter")return;r.preventDefault();let n=window.getSelection();if(!n.rangeCount)return;let t=n.getRangeAt(0);t.deleteContents();let o=document.createElement("br");t.insertNode(o),t.setStartAfter(o),t.setEndAfter(o),n.removeAllRanges(),n.addRange(t)}),e.addEventListener("paste",r=>{r.preventDefault();let t=r.clipboardData.getData("text/plain").split(/\r?\n/),o=window.getSelection(),i=o.getRangeAt(0);i.deleteContents(),t.forEach((s,d)=>{d>0&&(i.insertNode(document.createElement("br")),i.collapse(!1)),i.insertNode(document.createTextNode(s)),i.collapse(!1)}),o.removeAllRanges(),o.addRange(i)})}function v(e,r,n){if(!r||!n||!e)return;let t=r.content.cloneNode(!0),o=t.querySelector("li"),i=t.querySelector("[data-journal-heading]"),s=t.querySelector("[data-journal-text]"),d=t.querySelector("[data-journal-date]"),l=t.querySelector("[data-journal-image-wrapper]");if(g(o,{"data-entry-id":e.id,class:"journal-item"}),i&&(i.textContent=e.heading),s&&(s.textContent=e.text),d&&(d.textContent=e.date),s.innerHTML=e.text.replace(/\n/g,"<br>"),M(s),e.imageBlob){l.innerHTML="",l.classList.add("journal-image-wrapper");let a=document.createElement("img");a.classList.add("lazy-loaded-image","lazy"),a.setAttribute("alt",e.imageAlt||"");let c=URL.createObjectURL(e.imageBlob);a.dataset.src=c,a.src=c,a.onload=()=>{g(a,{width:a.naturalWidth,height:a.naturalHeight})};let u=new MutationObserver(A=>{A.forEach(f=>{f.removedNodes.forEach(y=>{y===a&&(URL.revokeObjectURL(c),u.disconnect())})})});u.observe(l,{childList:!0}),l.appendChild(a);let m=document.createElement("button");m.dataset.removeImageButton="",m.className="remove-image-button",m.textContent="Delete image",l.appendChild(m)}else l.innerHTML="";n.prepend(t)}function C(e,r,n,t){e.toggleAttribute("contenteditable");let o=n.find(i=>i.id===r.dataset.entryId);o.edited=!e.hasAttribute("contenteditable"),o.edited&&(o[t]=e.innerHTML.replace(/<br\s*\/?>/gi,`
`).trim())}function j(e){let r=e.target;r.textContent=r.textContent==="Edit"?"Save":"Edit",r.classList.toggle("edit-button"),r.classList.toggle("save-edit-button")}function _(e,r,n){let t=r.querySelector("[data-journal-text]");C(t,r,n,"text"),j(e)}function z(e,r,n){let t=r.querySelector("[data-journal-heading]");t.addEventListener("keydown",o=>{o.key==="Enter"&&o.preventDefault()}),C(t,r,n,"heading"),j(e)}function h(e){let r=document.getElementById("delete-all-entries");r&&(e.length>1?r.removeAttribute("disabled"):r.setAttribute("disabled",""))}function I(e){let r=[].slice.call(e.querySelectorAll(".lazy-loaded-image.lazy")),n=new IntersectionObserver(function(t){t.forEach(function(o){if(o.isIntersecting){let i=o.target;i.src=i.dataset.src,i.classList.remove("lazy"),n.unobserve(i)}})});r.forEach(function(t){n.observe(t)})}function $({entries:e=[],updateExportButton:r}={}){let n=document.getElementById("journal-form"),t=document.getElementById("journal-item-template"),o=document.createElement("ul"),i=document.getElementById("delete-all-entries");g(o,{class:"journal-list",id:"journal-list"}),n.after(o),e.forEach(d=>v(d,t,o)),h(e),r&&r(),I(o);function s(d){e.push(d),v(d,t,o),I(o),h(e),r&&r();let l=o.firstElementChild;if(l){g(l,{role:"status","aria-live":"polite",tabindex:"-1"}),l.focus(),l.classList.add("focus-highlight"),setTimeout(()=>l.classList.remove("focus-highlight"),2e3);let a=l.nextElementSibling;a&&g(a,{role:null,"aria-live":null,tabindex:null})}}return o.addEventListener("click",async d=>{let l=d.target.closest(".journal-item");if(!l)return;let a=e.find(c=>c.id===l.dataset.entryId);if(d.target.matches("[data-button-heading-edit]")){if(z(d,l,e),a)try{await B(a)}catch(c){console.error("Failed to update entry",c)}h(e),r&&r();return}if(d.target.matches("[data-button-text-edit]")){if(_(d,l,e),a)try{await B(a)}catch(c){console.error("Failed to update entry",c)}h(e),r&&r();return}if(d.target.matches("[data-remove-image-button]")){if(!confirm("Are you sure you want to delete the image?"))return;let c=l.querySelector("[data-journal-image-wrapper]");if(c&&(c.innerHTML=""),a){a.imageBlob=null,a.imageType=null,a.imageAlt="";try{await B(a)}catch(u){console.error("Failed to remove image in DB",u)}}h(e),r&&r();return}if(d.target.matches("[data-button-journal-delete]")){if(!confirm("Are you sure you want to delete this entry?"))return;l.remove();let c=l.dataset.entryId,u=e.findIndex(m=>m.id===c);u>-1&&e.splice(u,1);try{await K(c)}catch(m){console.error("Failed to delete entry from DB",m)}h(e),r&&r();return}}),i.addEventListener("click",async()=>{if(confirm("Delete ALL entries? This cannot be undone.")){try{await Z()}catch(d){console.error("Failed to clear DB",d)}e.length=0,o.innerHTML="",h(e),r&&r()}}),{addEntry:s}}function E(e){return String(e).padStart(2,"0")}function ae(e){return{dateString:`${e.getUTCFullYear()}-${E(e.getUTCMonth()+1)}-${E(e.getUTCDate())}`,timeString:`${E(e.getUTCHours())}-${E(e.getUTCMinutes())}-${E(e.getUTCSeconds())}`}}async function ie(e){if(!e)return null;let r=await e.arrayBuffer(),n="",t=new Uint8Array(r),o=t.byteLength;for(let i=0;i<o;i++)n+=String.fromCharCode(t[i]);return btoa(n)}async function le(e,r){try{let t=await(await window.showSaveFilePicker({suggestedName:r,types:[{description:"JSON file",accept:{"application/json":[".json"]}}]})).createWritable();return await t.write(e),await t.close(),!0}catch(n){if(n.name==="AbortError")return!0;throw n}}function de(e,r){let n=URL.createObjectURL(e),t=document.createElement("a");t.href=n,t.download=r,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}async function G(e="JOURNAL_2025-entries"){let r;try{r=await b()}catch(a){alert("Failed to read entries from the database"),console.error(a);return}if(!Array.isArray(r)||r.length===0){alert("No entries to export");return}let n=[];for(let a of r){let c={id:a.id,date:a.date,heading:a.heading,text:a.text,imageAlt:a.imageAlt||"",edited:a.edited||!1};if(a.imageBlob)try{let u=await ie(a.imageBlob);c.image={mime:a.imageType||"application/octet-stream",data:u}}catch(u){console.warn(`Failed to convert image for entry ${a.id}:`,u),c.image=null}else c.image=null;n.push(c)}let t=JSON.stringify(n,null,2),o=new Date,{dateString:i,timeString:s}=ae(o),d=`${e}-${i}_${s}.json`,l=new Blob([t],{type:"application/json"});if(window.showSaveFilePicker)try{await le(l,d);return}catch(a){console.error("Failed using file picker, falling back:",a)}de(l,d)}function W(){let e=document.getElementById("export-entries");if(!e)return{};async function r(){try{let n=await b();Array.isArray(n)&&n.length>0?e.removeAttribute("disabled"):e.setAttribute("disabled","")}catch(n){console.error("Failed to check entries for export button",n),e.setAttribute("disabled","")}}return e.addEventListener("click",async()=>{Q("Creating JSON file\u2026");try{await G(),O("JSON file ready.")}catch(n){console.error("Export failed:",n),O("Failed to create JSON file."),alert("Export failed. See console for details.")}}),r(),{updateButtonState:r}}k();D();F();R();async function ce(){if(!document.getElementById("journal-button-group"))return;let r=[];try{r=await b()}catch(o){console.error("Failed to load entries from IndexedDB",o)}let{updateButtonState:n}=W(),{addEntry:t}=$({entries:r,updateExportButton:n});J({addEntry:t,updateExportButton:n})}ce();})();
