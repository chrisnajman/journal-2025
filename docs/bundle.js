(()=>{var u=(e,r,n)=>new Promise((t,o)=>{var i=l=>{try{d(n.next(l))}catch(a){o(a)}},s=l=>{try{d(n.throw(l))}catch(a){o(a)}},d=l=>l.done?t(l.value):Promise.resolve(l.value).then(i,s);d((n=n.apply(e,r)).next())});function j(){window.onscroll=()=>{let e=[[document.getElementById("page-header"),"sticky-shadow-header"],[document.getElementById("page-footer"),"sticky-shadow-footer"]],r=document.body.scrollTop>0||document.documentElement.scrollTop>0;e.forEach(([n,t])=>n.classList[r?"add":"remove"](t))}}function F(){let r="JOURNAL-2025-theme",n=document.querySelector(".theme-toggler"),t=document.querySelector(".light"),o=document.querySelector(".dark"),i=n.querySelector(".light .visually-hidden"),s=n.querySelector(".dark .visually-hidden"),d=n.querySelector("button");function l(){try{let g=localStorage.getItem(r);return g?JSON.parse(g):!1}catch(g){return console.error("Error parsing theme from localStorage:",g),!1}}let a=l();function c(g){a=g,document.documentElement.classList.toggle("darkmode",a),localStorage.setItem(r,a),f()}function m(){c(!a)}function f(){i.textContent=a?" theme inactive":" theme active",s.textContent=a?" theme active":" theme inactive";let g=i.textContent,b=s.textContent;E(g,t),E(b,o),d.setAttribute("aria-pressed",a?"false":"true")}function E(g,b){g===" theme active"?b.classList.add("underline"):b.classList.remove("underline")}d.addEventListener("click",m),c(a)}function D(){let e=document.getElementById("loader"),r=document.getElementById("page-loaded");window.addEventListener("load",()=>{r.textContent="Page has loaded.",requestAnimationFrame(()=>{e.classList.add("loader-hidden")})})}function V(e="Working\u2026"){let r=document.getElementById("loader"),n=document.getElementById("page-loaded");if(!r)return;let t=r.querySelector(".visually-hidden");t&&(t.textContent=e),n&&(n.textContent=e),r.classList.remove("loader-hidden")}function O(e="Done."){let r=document.getElementById("loader"),n=document.getElementById("page-loaded");if(!r)return;let t=r.querySelector(".visually-hidden");t&&(t.textContent=e),n&&(n.textContent=e),requestAnimationFrame(()=>{r.classList.add("loader-hidden")})}function R(){let e=document.querySelector("html"),r=document.querySelector(".header");new ResizeObserver(t=>{for(let o of t){let i=getComputedStyle(o.target),s=getComputedStyle(e),d=parseFloat(i.paddingBlockStart),l=parseFloat(i.paddingBlockEnd),a=d+l,c=parseFloat(s.getPropertyValue("--skip-link-gap"))||0,m=a+c,f=(o.contentRect.height+m)/16;e.style=`scroll-padding-top: ${f}rem`}}).observe(r)}function p(e,r){for(let[n,t]of Object.entries(r))t==null?e.removeAttribute(n):e.setAttribute(n,t)}var Z="Enter a title...",ee="Enter some text...",te="Enter alt text...";function q(e,r,n){e.getAttribute("placeholder")===""&&e.setAttribute("placeholder",Z),r.getAttribute("placeholder")===""&&r.setAttribute("placeholder",ee),n&&n.getAttribute("placeholder")===""&&n.setAttribute("placeholder",te)}function S(e,r,n){e.setAttribute("required",""),r.setAttribute("required",""),n.setAttribute("required","")}function X(e,r){e.date.value=r,e.heading.value="",e.text.value="",e.image.input.value="",e.image.altText.value="",e.image.wrapper.classList.add("hide")}function Y(e){e.charCounter.textContent="0/150",e.charLimit.textContent="",e.cancelButton.setAttribute("disabled","")}function w(e,r){X(e,r),Y(e.image),e.form.classList.add("hide"),e.buttons.create.removeAttribute("disabled")}function N(e){e.wrapper.classList.remove("hide"),e.cancelButton.removeAttribute("disabled")}function P(e){e.input.value="",e.wrapper.classList.add("hide"),e.altText.value="",e.charCounter.textContent="0/150",e.charLimit.textContent="",e.cancelButton.setAttribute("disabled","")}function U(e,r,n){let t=e.value.length;r.textContent=`${t}/150`,n.textContent=t===150?"No more characters allowed!":""}var re="journal2025",h="entries";var L;function T(){return new Promise((e,r)=>{if(L)return e(L);let n=indexedDB.open(re,1);n.onerror=()=>r(n.error),n.onsuccess=()=>{L=n.result,e(L)},n.onupgradeneeded=t=>{let o=t.target.result;o.objectStoreNames.contains(h)||o.createObjectStore(h,{keyPath:"id"})}})}function H(e){return new Promise((r,n)=>u(null,null,function*(){try{let o=(yield T()).transaction(h,"readwrite");o.objectStore(h).put(e),o.oncomplete=()=>r(),o.onerror=()=>n(o.error)}catch(t){n(t)}}))}function x(){return new Promise((e,r)=>u(null,null,function*(){try{let i=(yield T()).transaction(h,"readonly").objectStore(h).getAll();i.onsuccess=()=>e(i.result),i.onerror=()=>r(i.error)}catch(n){r(n)}}))}function B(e){return H(e)}function K(e){return new Promise((r,n)=>u(null,null,function*(){try{let o=(yield T()).transaction(h,"readwrite");o.objectStore(h).delete(e),o.oncomplete=()=>r(),o.onerror=()=>n(o.error)}catch(t){n(t)}}))}function Q(){return new Promise((e,r)=>u(null,null,function*(){try{let t=(yield T()).transaction(h,"readwrite");t.objectStore(h).clear(),t.oncomplete=()=>e(),t.onerror=()=>r(t.error)}catch(n){r(n)}}))}function J({addEntry:e,updateExportButton:r}={}){let n=new Date().toISOString().split("T")[0],t={form:document.getElementById("journal-form"),heading:document.getElementById("journal-heading"),text:document.getElementById("journal-text"),date:document.getElementById("journal-entry-date"),image:{input:document.getElementById("image-input"),wrapper:document.getElementById("alt-text-wrapper"),altText:document.getElementById("image-alt"),charCounter:document.getElementById("character-count"),charLimit:document.getElementById("character-limit-message"),cancelButton:document.querySelector("[data-cancel-image-upload-button]"),fileBlob:null,fileType:null},buttons:{create:document.getElementById("create-entry"),cancel:document.getElementById("cancel")}};t.date.value=n,t.image.altText.value="",t.image.altText.addEventListener("input",()=>{U(t.image.altText,t.image.charCounter,t.image.charLimit)}),t.buttons.create.addEventListener("click",o=>{o.target.setAttribute("disabled","true"),t.form.classList.remove("hide"),p(t.form,{role:"region",tabindex:"-1","aria-label":"Journal entry form"}),t.form.focus(),t.form.classList.add("focus-highlight"),setTimeout(()=>{t.form.classList.remove("focus-highlight"),p(t.form,{role:null,tabindex:null,"aria-label":null})},2e3),S(t.date,t.heading,t.text)}),t.buttons.cancel.addEventListener("click",()=>{w(t,n),t.image.fileBlob=null,t.image.fileType=null}),t.image.input.addEventListener("change",o=>{if(o.target.files&&o.target.files.length>0){let i=o.target.files[0];t.image.fileBlob=i,t.image.fileType=i.type,N(t.image)}}),t.image.cancelButton.addEventListener("click",()=>{P(t.image),t.image.fileBlob=null,t.image.fileType=null}),t.form.addEventListener("submit",o=>u(null,null,function*(){o.preventDefault(),q(t.heading,t.text,t.image.altText);let i={date:t.date.value.split("-").reverse().join("/"),heading:t.heading.value,text:t.text.value,edited:!1,id:new Date().valueOf().toString(),imageAlt:t.image.altText.value||"",imageBlob:t.image.fileBlob||null,imageType:t.image.fileType||null};try{yield H(i)}catch(s){console.error("Failed to save entry to IndexedDB",s)}e(i),r&&r(),w(t,n),t.image.fileBlob=null,t.image.fileType=null}))}function z(e){e.addEventListener("keydown",r=>{if(r.key!=="Enter")return;r.preventDefault();let n=window.getSelection();if(!n.rangeCount)return;let t=n.getRangeAt(0);t.deleteContents();let o=document.createElement("br");t.insertNode(o),t.setStartAfter(o),t.setEndAfter(o),n.removeAllRanges(),n.addRange(t)}),e.addEventListener("paste",r=>{r.preventDefault();let t=r.clipboardData.getData("text/plain").split(/\r?\n/),o=window.getSelection(),i=o.getRangeAt(0);i.deleteContents(),t.forEach((s,d)=>{d>0&&(i.insertNode(document.createElement("br")),i.collapse(!1)),i.insertNode(document.createTextNode(s)),i.collapse(!1)}),o.removeAllRanges(),o.addRange(i)})}function v(e,r,n){if(!r||!n||!e)return;let t=r.content.cloneNode(!0),o=t.querySelector("li"),i=t.querySelector("[data-journal-heading]"),s=t.querySelector("[data-journal-text]"),d=t.querySelector("[data-journal-date]"),l=t.querySelector("[data-journal-image-wrapper]");if(p(o,{"data-entry-id":e.id,class:"journal-item"}),i&&(i.textContent=e.heading),s&&(s.textContent=e.text),d&&(d.textContent=e.date),s.innerHTML=e.text.replace(/\n/g,"<br>"),z(s),e.imageBlob){l.innerHTML="",l.classList.add("journal-image-wrapper");let a=document.createElement("img");a.classList.add("lazy-loaded-image","lazy"),a.setAttribute("alt",e.imageAlt||"");let c=URL.createObjectURL(e.imageBlob);a.dataset.src=c,a.src=c,a.onload=()=>{p(a,{width:a.naturalWidth,height:a.naturalHeight})};let m=new MutationObserver(E=>{E.forEach(g=>{g.removedNodes.forEach(b=>{b===a&&(URL.revokeObjectURL(c),m.disconnect())})})});m.observe(l,{childList:!0}),l.appendChild(a);let f=document.createElement("button");f.dataset.removeImageButton="",f.className="remove-image-button",f.textContent="Delete image",l.appendChild(f)}else l.innerHTML="";n.prepend(t)}function C(e,r,n,t){e.toggleAttribute("contenteditable");let o=n.find(i=>i.id===r.dataset.entryId);o.edited=!e.hasAttribute("contenteditable"),o.edited&&(o[t]=e.innerHTML.replace(/<br\s*\/?>/gi,`
`).trim())}function I(e){let r=e.target;r.textContent=r.textContent==="Edit"?"Save":"Edit",r.classList.toggle("edit-button"),r.classList.toggle("save-edit-button")}function M(e,r,n){let t=r.querySelector("[data-journal-text]");C(t,r,n,"text"),I(e)}function $(e,r,n){let t=r.querySelector("[data-journal-heading]");t.addEventListener("keydown",o=>{o.key==="Enter"&&o.preventDefault()}),C(t,r,n,"heading"),I(e)}function y(e){let r=document.getElementById("delete-all-entries");r&&(e.length>1?r.removeAttribute("disabled"):r.setAttribute("disabled",""))}function k(e){let r=[].slice.call(e.querySelectorAll(".lazy-loaded-image.lazy")),n=new IntersectionObserver(function(t){t.forEach(function(o){if(o.isIntersecting){let i=o.target;i.src=i.dataset.src,i.classList.remove("lazy"),n.unobserve(i)}})});r.forEach(function(t){n.observe(t)})}function _({entries:e=[],updateExportButton:r}={}){let n=document.getElementById("journal-form"),t=document.getElementById("journal-item-template"),o=document.createElement("ul"),i=document.getElementById("delete-all-entries");p(o,{class:"journal-list",id:"journal-list"}),n.after(o),e.forEach(d=>v(d,t,o)),y(e),r&&r(),k(o);function s(d){e.push(d),v(d,t,o),k(o),y(e),r&&r();let l=o.firstElementChild;if(l){p(l,{role:"status","aria-live":"polite",tabindex:"-1"}),l.focus(),l.classList.add("focus-highlight"),setTimeout(()=>l.classList.remove("focus-highlight"),2e3);let a=l.nextElementSibling;a&&p(a,{role:null,"aria-live":null,tabindex:null})}}return o.addEventListener("click",d=>u(null,null,function*(){let l=d.target.closest(".journal-item");if(!l)return;let a=e.find(c=>c.id===l.dataset.entryId);if(d.target.matches("[data-button-heading-edit]")){if($(d,l,e),a)try{yield B(a)}catch(c){console.error("Failed to update entry",c)}y(e),r&&r();return}if(d.target.matches("[data-button-text-edit]")){if(M(d,l,e),a)try{yield B(a)}catch(c){console.error("Failed to update entry",c)}y(e),r&&r();return}if(d.target.matches("[data-remove-image-button]")){if(!confirm("Are you sure you want to delete the image?"))return;let c=l.querySelector("[data-journal-image-wrapper]");if(c&&(c.innerHTML=""),a){a.imageBlob=null,a.imageType=null,a.imageAlt="";try{yield B(a)}catch(m){console.error("Failed to remove image in DB",m)}}y(e),r&&r();return}if(d.target.matches("[data-button-journal-delete]")){if(!confirm("Are you sure you want to delete this entry?"))return;l.remove();let c=l.dataset.entryId,m=e.findIndex(f=>f.id===c);m>-1&&e.splice(m,1);try{yield K(c)}catch(f){console.error("Failed to delete entry from DB",f)}y(e),r&&r();return}})),i.addEventListener("click",()=>u(null,null,function*(){if(confirm("Delete ALL entries? This cannot be undone.")){try{yield Q()}catch(d){console.error("Failed to clear DB",d)}e.length=0,o.innerHTML="",y(e),r&&r()}})),{addEntry:s}}function A(e){return String(e).padStart(2,"0")}function ne(e){return{dateString:`${e.getUTCFullYear()}-${A(e.getUTCMonth()+1)}-${A(e.getUTCDate())}`,timeString:`${A(e.getUTCHours())}-${A(e.getUTCMinutes())}-${A(e.getUTCSeconds())}`}}function oe(e){return u(this,null,function*(){if(!e)return null;let r=yield e.arrayBuffer(),n="",t=new Uint8Array(r),o=t.byteLength;for(let i=0;i<o;i++)n+=String.fromCharCode(t[i]);return btoa(n)})}function ae(e,r){return u(this,null,function*(){try{let t=yield(yield window.showSaveFilePicker({suggestedName:r,types:[{description:"JSON file",accept:{"application/json":[".json"]}}]})).createWritable();return yield t.write(e),yield t.close(),!0}catch(n){if(n.name==="AbortError")return!0;throw n}})}function ie(e,r){let n=URL.createObjectURL(e),t=document.createElement("a");t.href=n,t.download=r,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(n)}function G(e="JOURNAL_2025-entries"){return u(this,null,function*(){let r;try{r=yield x()}catch(a){alert("Failed to read entries from the database"),console.error(a);return}if(!Array.isArray(r)||r.length===0){alert("No entries to export");return}let n=[];for(let a of r){let c={id:a.id,date:a.date,heading:a.heading,text:a.text,imageAlt:a.imageAlt||"",edited:a.edited||!1};if(a.imageBlob)try{let m=yield oe(a.imageBlob);c.image={mime:a.imageType||"application/octet-stream",data:m}}catch(m){console.warn(`Failed to convert image for entry ${a.id}:`,m),c.image=null}else c.image=null;n.push(c)}let t=JSON.stringify(n,null,2),o=new Date,{dateString:i,timeString:s}=ne(o),d=`${e}-${i}_${s}.json`,l=new Blob([t],{type:"application/json"});if(window.showSaveFilePicker)try{yield ae(l,d);return}catch(a){console.error("Failed using file picker, falling back:",a)}ie(l,d)})}function W(){let e=document.getElementById("export-entries");if(!e)return{};function r(){return u(this,null,function*(){try{let n=yield x();Array.isArray(n)&&n.length>0?e.removeAttribute("disabled"):e.setAttribute("disabled","")}catch(n){console.error("Failed to check entries for export button",n),e.setAttribute("disabled","")}})}return e.addEventListener("click",()=>u(null,null,function*(){V("Creating JSON file\u2026");try{yield G(),O("JSON file ready.")}catch(n){console.error("Export failed:",n),O("Failed to create JSON file."),alert("Export failed. See console for details.")}})),r(),{updateButtonState:r}}j();F();D();R();function le(){return u(this,null,function*(){let e=[];try{e=yield x()}catch(t){console.error("Failed to load entries from IndexedDB",t)}let{updateButtonState:r}=W(),{addEntry:n}=_({entries:e,updateExportButton:r});J({addEntry:n,updateExportButton:r})})}le();})();
