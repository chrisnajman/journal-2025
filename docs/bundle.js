(()=>{var s=(e,r,o)=>new Promise((t,n)=>{var i=l=>{try{c(o.next(l))}catch(a){n(a)}},f=l=>{try{c(o.throw(l))}catch(a){n(a)}},c=l=>l.done?t(l.value):Promise.resolve(l.value).then(i,f);c((o=o.apply(e,r)).next())});function D(){window.onscroll=()=>{let e=[[document.getElementById("page-header"),"sticky-shadow-header"],[document.getElementById("page-footer"),"sticky-shadow-footer"]],r=document.body.scrollTop>0||document.documentElement.scrollTop>0;e.forEach(([o,t])=>o.classList[r?"add":"remove"](t))}}function k(){let r="JOURNAL-2025-theme",o=document.querySelector(".theme-toggler"),t=document.querySelector(".light"),n=document.querySelector(".dark"),i=o.querySelector(".light .visually-hidden"),f=o.querySelector(".dark .visually-hidden"),c=o.querySelector("button");function l(){try{let g=localStorage.getItem(r);return g?JSON.parse(g):!1}catch(g){return console.error("Error parsing theme from localStorage:",g),!1}}let a=l();function d(g){a=g,document.documentElement.classList.toggle("darkmode",a),localStorage.setItem(r,a),m()}function u(){d(!a)}function m(){i.textContent=a?" theme inactive":" theme active",f.textContent=a?" theme active":" theme inactive";let g=i.textContent,b=f.textContent;E(g,t),E(b,n),c.setAttribute("aria-pressed",a?"false":"true")}function E(g,b){g===" theme active"?b.classList.add("underline"):b.classList.remove("underline")}c.addEventListener("click",u),d(a)}function q(){window.addEventListener("load",()=>{let e=document.getElementById("loader"),r=document.getElementById("page-loaded");e.classList.add("loader-hidden"),e.addEventListener("transitionend",()=>{e.remove(),r.textContent="Page has loaded.",r.setAttribute("aria-hidden","false")})})}function F(){let e=document.querySelector("html"),r=document.querySelector(".header");new ResizeObserver(t=>{for(let n of t){let i=getComputedStyle(n.target),f=getComputedStyle(e),c=parseFloat(i.paddingBlockStart),l=parseFloat(i.paddingBlockEnd),a=c+l,d=parseFloat(f.getPropertyValue("--skip-link-gap"))||0,u=a+d,m=(n.contentRect.height+u)/16;e.style=`scroll-padding-top: ${m}rem`}}).observe(r)}function p(e,r){for(let[o,t]of Object.entries(r))t==null?e.removeAttribute(o):e.setAttribute(o,t)}var Y="Enter a title...",K="Enter some text...",Q="Enter alt text...";function O(e,r,o){e.getAttribute("placeholder")===""&&e.setAttribute("placeholder",Y),r.getAttribute("placeholder")===""&&r.setAttribute("placeholder",K),o&&o.getAttribute("placeholder")===""&&o.setAttribute("placeholder",Q)}function L(e,r,o,t,n){e.setAttribute("required",""),r.setAttribute("required",""),o.setAttribute("required",""),t.classList.contains("hide")||n.setAttribute("required","")}function G(e,r){e.date.value=r,e.heading.value="",e.text.value="",e.image.input.value="",e.image.altText.value="",e.image.wrapper.classList.add("hide")}function V(e){e.charCounter.textContent="0/150",e.charLimit.textContent="",e.altText.removeAttribute("required"),e.cancelButton.setAttribute("disabled","")}function T(e,r){G(e,r),V(e.image),e.form.classList.add("hide"),e.buttons.create.removeAttribute("disabled")}function R(e){e.wrapper.classList.remove("hide"),e.altText.setAttribute("required",""),e.cancelButton.removeAttribute("disabled")}function H(e){e.input.value="",e.wrapper.classList.add("hide"),e.altText.removeAttribute("required"),e.altText.value="",e.charCounter.textContent="0/150",e.charLimit.textContent="",e.cancelButton.setAttribute("disabled","")}function U(e,r,o){let t=e.value.length;r.textContent=`${t}/150`,o.textContent=t===150?"No more characters allowed!":""}var Z="journal2025",h="entries";var S;function w(){return new Promise((e,r)=>{if(S)return e(S);let o=indexedDB.open(Z,1);o.onerror=()=>r(o.error),o.onsuccess=()=>{S=o.result,e(S)},o.onupgradeneeded=t=>{let n=t.target.result;n.objectStoreNames.contains(h)||n.createObjectStore(h,{keyPath:"id"})}})}function P(e){return new Promise((r,o)=>s(null,null,function*(){try{let n=(yield w()).transaction(h,"readwrite");n.objectStore(h).put(e),n.oncomplete=()=>r(),n.onerror=()=>o(n.error)}catch(t){o(t)}}))}function x(){return new Promise((e,r)=>s(null,null,function*(){try{let i=(yield w()).transaction(h,"readonly").objectStore(h).getAll();i.onsuccess=()=>e(i.result),i.onerror=()=>r(i.error)}catch(o){r(o)}}))}function B(e){return P(e)}function W(e){return new Promise((r,o)=>s(null,null,function*(){try{let n=(yield w()).transaction(h,"readwrite");n.objectStore(h).delete(e),n.oncomplete=()=>r(),n.onerror=()=>o(n.error)}catch(t){o(t)}}))}function X(){return new Promise((e,r)=>s(null,null,function*(){try{let t=(yield w()).transaction(h,"readwrite");t.objectStore(h).clear(),t.oncomplete=()=>e(),t.onerror=()=>r(t.error)}catch(o){r(o)}}))}function N({addEntry:e,updateExportButton:r}={}){let o=new Date().toISOString().split("T")[0],t={form:document.getElementById("journal-form"),heading:document.getElementById("journal-heading"),text:document.getElementById("journal-text"),date:document.getElementById("journal-entry-date"),image:{input:document.getElementById("image-input"),wrapper:document.getElementById("alt-text-wrapper"),altText:document.getElementById("image-alt"),charCounter:document.getElementById("character-count"),charLimit:document.getElementById("character-limit-message"),cancelButton:document.querySelector("[data-cancel-image-upload-button]"),fileBlob:null,fileType:null},buttons:{create:document.getElementById("create-entry"),cancel:document.getElementById("cancel")}};t.date.value=o,t.image.altText.value="",t.image.altText.addEventListener("input",()=>{U(t.image.altText,t.image.charCounter,t.image.charLimit)}),t.buttons.create.addEventListener("click",n=>{n.target.setAttribute("disabled","true"),t.form.classList.remove("hide"),p(t.form,{role:"region",tabindex:"-1","aria-label":"Journal entry form"}),t.form.focus(),t.form.classList.add("focus-highlight"),setTimeout(()=>{t.form.classList.remove("focus-highlight"),p(t.form,{role:null,tabindex:null,"aria-label":null})},2e3),L(t.date,t.heading,t.text,t.image.wrapper,t.image.altText)}),t.buttons.cancel.addEventListener("click",()=>{T(t,o),t.image.fileBlob=null,t.image.fileType=null}),t.image.input.addEventListener("change",n=>{if(n.target.files&&n.target.files.length>0){let i=n.target.files[0];t.image.fileBlob=i,t.image.fileType=i.type,R(t.image)}}),t.image.cancelButton.addEventListener("click",()=>{H(t.image),t.image.fileBlob=null,t.image.fileType=null}),t.form.addEventListener("submit",n=>s(null,null,function*(){n.preventDefault(),t.image.wrapper.classList.contains("hide")&&t.image.altText.removeAttribute("required"),O(t.heading,t.text,t.image.altText);let i={date:t.date.value.split("-").reverse().join("/"),heading:t.heading.value,text:t.text.value,edited:!1,id:new Date().valueOf().toString(),imageAlt:t.image.altText.value||"",imageBlob:t.image.fileBlob||null,imageType:t.image.fileType||null};try{yield P(i)}catch(f){console.error("Failed to save entry to IndexedDB",f)}e(i),r&&r(),T(t,o),t.image.fileBlob=null,t.image.fileType=null}))}function v(e,r,o){if(!r||!o||!e)return;let t=r.content.cloneNode(!0),n=t.querySelector("li"),i=t.querySelector("[data-journal-heading]"),f=t.querySelector("[data-journal-text]"),c=t.querySelector("[data-journal-date]"),l=t.querySelector("[data-journal-image-wrapper]");if(p(n,{"data-entry-id":e.id,class:"journal-item"}),i&&(i.textContent=e.heading),f&&(f.textContent=e.text),c&&(c.textContent=e.date),e.imageBlob){l.innerHTML="";let a=document.createElement("img");a.classList.add("lazy-loaded-image","lazy"),a.alt=e.imageAlt||"";let d=URL.createObjectURL(e.imageBlob);a.dataset.src=d,a.src=d,a.onload=()=>{p(a,{width:a.naturalWidth,height:a.naturalHeight})};let u=new MutationObserver(E=>{E.forEach(g=>{g.removedNodes.forEach(b=>{b===a&&(URL.revokeObjectURL(d),u.disconnect())})})});u.observe(l,{childList:!0}),l.appendChild(a);let m=document.createElement("button");m.dataset.removeImageButton="",m.className="remove-image-button",m.textContent="Delete image",l.appendChild(m)}else l.innerHTML="";o.prepend(t)}function I(e,r,o,t){e.toggleAttribute("contenteditable");let n=o.find(i=>i.id===r.dataset.entryId);n.edited=!e.hasAttribute("contenteditable"),n.edited&&(n[t]=e.innerHTML.replace(/<br\s*\/?>/gi,`
`).trim())}function C(e){let r=e.target;r.textContent=r.textContent==="Edit"?"Save":"Edit",r.classList.toggle("edit-button"),r.classList.toggle("save-edit-button")}function z(e,r,o){let t=r.querySelector("[data-journal-text]");I(t,r,o,"text"),C(e)}function M(e,r,o){let t=r.querySelector("[data-journal-heading]");t.addEventListener("keydown",n=>{n.key==="Enter"&&n.preventDefault()}),I(t,r,o,"heading"),C(e)}function y(e){let r=document.getElementById("delete-all-entries");r&&(e.length>1?r.removeAttribute("disabled"):r.setAttribute("disabled",""))}function j(e){let r=[].slice.call(e.querySelectorAll(".lazy-loaded-image.lazy")),o=new IntersectionObserver(function(t){t.forEach(function(n){if(n.isIntersecting){let i=n.target;i.src=i.dataset.src,i.classList.remove("lazy"),o.unobserve(i)}})});r.forEach(function(t){o.observe(t)})}function $({entries:e=[],updateExportButton:r}={}){let o=document.getElementById("journal-form"),t=document.getElementById("journal-item-template"),n=document.createElement("ul"),i=document.getElementById("delete-all-entries");p(n,{class:"journal-list",id:"journal-list"}),o.after(n),e.forEach(c=>v(c,t,n)),y(e),r&&r(),j(n);function f(c){e.push(c),v(c,t,n),j(n),y(e),r&&r();let l=n.firstElementChild;if(l){p(l,{role:"status","aria-live":"polite",tabindex:"-1"}),l.focus(),l.classList.add("focus-highlight"),setTimeout(()=>l.classList.remove("focus-highlight"),2e3);let a=l.nextElementSibling;a&&p(a,{role:null,"aria-live":null,tabindex:null})}}return n.addEventListener("click",c=>s(null,null,function*(){let l=c.target.closest(".journal-item");if(!l)return;let a=e.find(d=>d.id===l.dataset.entryId);if(c.target.matches("[data-button-heading-edit]")){if(M(c,l,e),a)try{yield B(a)}catch(d){console.error("Failed to update entry",d)}y(e),r&&r();return}if(c.target.matches("[data-button-text-edit]")){if(z(c,l,e),a)try{yield B(a)}catch(d){console.error("Failed to update entry",d)}y(e),r&&r();return}if(c.target.matches("[data-remove-image-button]")){let d=l.querySelector("[data-journal-image-wrapper]");if(d&&(d.innerHTML=""),a){a.imageBlob=null,a.imageType=null,a.imageAlt="";try{yield B(a)}catch(u){console.error("Failed to remove image in DB",u)}}y(e),r&&r();return}if(c.target.matches("[data-button-journal-delete]")){if(!confirm("Are you sure you want to delete this entry?"))return;l.remove();let d=l.dataset.entryId,u=e.findIndex(m=>m.id===d);u>-1&&e.splice(u,1);try{yield W(d)}catch(m){console.error("Failed to delete entry from DB",m)}y(e),r&&r();return}})),i.addEventListener("click",()=>s(null,null,function*(){if(confirm("Delete ALL entries? This cannot be undone.")){try{yield X()}catch(c){console.error("Failed to clear DB",c)}e.length=0,n.innerHTML="",y(e),r&&r()}})),{addEntry:f}}function A(e){return String(e).padStart(2,"0")}function ee(e){return{dateString:`${e.getUTCFullYear()}-${A(e.getUTCMonth()+1)}-${A(e.getUTCDate())}`,timeString:`${A(e.getUTCHours())}-${A(e.getUTCMinutes())}-${A(e.getUTCSeconds())}`}}function te(e){return s(this,null,function*(){if(!e)return null;let r=yield e.arrayBuffer(),o="",t=new Uint8Array(r),n=t.byteLength;for(let i=0;i<n;i++)o+=String.fromCharCode(t[i]);return btoa(o)})}function _(e="JOURNAL_2025-entries"){return s(this,null,function*(){let r;try{r=yield x()}catch(d){alert("Failed to read entries from the database"),console.error(d);return}if(!Array.isArray(r)||r.length===0){alert("No entries to export");return}let o=[];for(let d of r){let u={id:d.id,date:d.date,heading:d.heading,text:d.text,imageAlt:d.imageAlt||"",edited:d.edited||!1};if(d.imageBlob)try{let m=yield te(d.imageBlob);u.image={mime:d.imageType||"application/octet-stream",data:m}}catch(m){console.warn(`Failed to convert image for entry ${d.id}:`,m),u.image=null}else u.image=null;o.push(u)}let t=JSON.stringify(o,null,2),n=new Date,{dateString:i,timeString:f}=ee(n),c=new Blob([t],{type:"application/json"}),l=URL.createObjectURL(c),a=document.createElement("a");a.href=l,a.download=`${e}-${i}_${f}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(l)})}function J(){let e=document.getElementById("export-entries");if(!e)return{};function r(){return s(this,null,function*(){try{let o=yield x();Array.isArray(o)&&o.length>0?e.removeAttribute("disabled"):e.setAttribute("disabled","")}catch(o){console.error("Failed to check entries for export button",o),e.setAttribute("disabled","")}})}return e.addEventListener("click",()=>s(null,null,function*(){yield _()})),r(),{updateButtonState:r}}D();k();q();F();function re(){return s(this,null,function*(){let e=[];try{e=yield x()}catch(t){console.error("Failed to load entries from IndexedDB",t)}let{updateButtonState:r}=J(),{addEntry:o}=$({entries:e,updateExportButton:r});N({addEntry:o,updateExportButton:r})})}re();})();
