(()=>{var u=(e,r,n)=>new Promise((t,o)=>{var i=l=>{try{c(n.next(l))}catch(a){o(a)}},s=l=>{try{c(n.throw(l))}catch(a){o(a)}},c=l=>l.done?t(l.value):Promise.resolve(l.value).then(i,s);c((n=n.apply(e,r)).next())});function k(){window.onscroll=()=>{let e=[[document.getElementById("page-header"),"sticky-shadow-header"],[document.getElementById("page-footer"),"sticky-shadow-footer"]],r=document.body.scrollTop>0||document.documentElement.scrollTop>0;e.forEach(([n,t])=>n.classList[r?"add":"remove"](t))}}function D(){let r="JOURNAL-2025-theme",n=document.querySelector(".theme-toggler"),t=document.querySelector(".light"),o=document.querySelector(".dark"),i=n.querySelector(".light .visually-hidden"),s=n.querySelector(".dark .visually-hidden"),c=n.querySelector("button");function l(){try{let f=localStorage.getItem(r);return f?JSON.parse(f):!1}catch(f){return console.error("Error parsing theme from localStorage:",f),!1}}let a=l();function d(f){a=f,document.documentElement.classList.toggle("darkmode",a),localStorage.setItem(r,a),g()}function m(){d(!a)}function g(){i.textContent=a?" theme inactive":" theme active",s.textContent=a?" theme active":" theme inactive";let f=i.textContent,y=s.textContent;E(f,t),E(y,o),c.setAttribute("aria-pressed",a?"false":"true")}function E(f,y){f===" theme active"?y.classList.add("underline"):y.classList.remove("underline")}c.addEventListener("click",m),d(a)}function F(){window.addEventListener("load",()=>{let e=document.getElementById("loader"),r=document.getElementById("page-loaded");e.classList.add("loader-hidden"),e.addEventListener("transitionend",()=>{e.remove(),r.textContent="Page has loaded.",r.setAttribute("aria-hidden","false")})})}function q(){let e=document.querySelector("html"),r=document.querySelector(".header");new ResizeObserver(t=>{for(let o of t){let i=getComputedStyle(o.target),s=getComputedStyle(e),c=parseFloat(i.paddingBlockStart),l=parseFloat(i.paddingBlockEnd),a=c+l,d=parseFloat(s.getPropertyValue("--skip-link-gap"))||0,m=a+d,g=(o.contentRect.height+m)/16;e.style=`scroll-padding-top: ${g}rem`}}).observe(r)}function p(e,r){for(let[n,t]of Object.entries(r))t==null?e.removeAttribute(n):e.setAttribute(n,t)}var K="Enter a title...",Q="Enter some text...",Z="Enter alt text...";function R(e,r,n){e.getAttribute("placeholder")===""&&e.setAttribute("placeholder",K),r.getAttribute("placeholder")===""&&r.setAttribute("placeholder",Q),n&&n.getAttribute("placeholder")===""&&n.setAttribute("placeholder",Z)}function L(e,r,n,t,o){e.setAttribute("required",""),r.setAttribute("required",""),n.setAttribute("required",""),t.classList.contains("hide")||o.setAttribute("required","")}function V(e,r){e.date.value=r,e.heading.value="",e.text.value="",e.image.input.value="",e.image.altText.value="",e.image.wrapper.classList.add("hide")}function W(e){e.charCounter.textContent="0/150",e.charLimit.textContent="",e.altText.removeAttribute("required"),e.cancelButton.setAttribute("disabled","")}function T(e,r){V(e,r),W(e.image),e.form.classList.add("hide"),e.buttons.create.removeAttribute("disabled")}function O(e){e.wrapper.classList.remove("hide"),e.altText.setAttribute("required",""),e.cancelButton.removeAttribute("disabled")}function U(e){e.input.value="",e.wrapper.classList.add("hide"),e.altText.removeAttribute("required"),e.altText.value="",e.charCounter.textContent="0/150",e.charLimit.textContent="",e.cancelButton.setAttribute("disabled","")}function N(e,r,n){let t=e.value.length;r.textContent=`${t}/150`,n.textContent=t===150?"No more characters allowed!":""}var ee="journal2025",h="entries";var S;function w(){return new Promise((e,r)=>{if(S)return e(S);let n=indexedDB.open(ee,1);n.onerror=()=>r(n.error),n.onsuccess=()=>{S=n.result,e(S)},n.onupgradeneeded=t=>{let o=t.target.result;o.objectStoreNames.contains(h)||o.createObjectStore(h,{keyPath:"id"})}})}function P(e){return new Promise((r,n)=>u(null,null,function*(){try{let o=(yield w()).transaction(h,"readwrite");o.objectStore(h).put(e),o.oncomplete=()=>r(),o.onerror=()=>n(o.error)}catch(t){n(t)}}))}function x(){return new Promise((e,r)=>u(null,null,function*(){try{let i=(yield w()).transaction(h,"readonly").objectStore(h).getAll();i.onsuccess=()=>e(i.result),i.onerror=()=>r(i.error)}catch(n){r(n)}}))}function B(e){return P(e)}function X(e){return new Promise((r,n)=>u(null,null,function*(){try{let o=(yield w()).transaction(h,"readwrite");o.objectStore(h).delete(e),o.oncomplete=()=>r(),o.onerror=()=>n(o.error)}catch(t){n(t)}}))}function Y(){return new Promise((e,r)=>u(null,null,function*(){try{let t=(yield w()).transaction(h,"readwrite");t.objectStore(h).clear(),t.oncomplete=()=>e(),t.onerror=()=>r(t.error)}catch(n){r(n)}}))}function H({addEntry:e,updateExportButton:r}={}){let n=new Date().toISOString().split("T")[0],t={form:document.getElementById("journal-form"),heading:document.getElementById("journal-heading"),text:document.getElementById("journal-text"),date:document.getElementById("journal-entry-date"),image:{input:document.getElementById("image-input"),wrapper:document.getElementById("alt-text-wrapper"),altText:document.getElementById("image-alt"),charCounter:document.getElementById("character-count"),charLimit:document.getElementById("character-limit-message"),cancelButton:document.querySelector("[data-cancel-image-upload-button]"),fileBlob:null,fileType:null},buttons:{create:document.getElementById("create-entry"),cancel:document.getElementById("cancel")}};t.date.value=n,t.image.altText.value="",t.image.altText.addEventListener("input",()=>{N(t.image.altText,t.image.charCounter,t.image.charLimit)}),t.buttons.create.addEventListener("click",o=>{o.target.setAttribute("disabled","true"),t.form.classList.remove("hide"),p(t.form,{role:"region",tabindex:"-1","aria-label":"Journal entry form"}),t.form.focus(),t.form.classList.add("focus-highlight"),setTimeout(()=>{t.form.classList.remove("focus-highlight"),p(t.form,{role:null,tabindex:null,"aria-label":null})},2e3),L(t.date,t.heading,t.text,t.image.wrapper,t.image.altText)}),t.buttons.cancel.addEventListener("click",()=>{T(t,n),t.image.fileBlob=null,t.image.fileType=null}),t.image.input.addEventListener("change",o=>{if(o.target.files&&o.target.files.length>0){let i=o.target.files[0];t.image.fileBlob=i,t.image.fileType=i.type,O(t.image)}}),t.image.cancelButton.addEventListener("click",()=>{U(t.image),t.image.fileBlob=null,t.image.fileType=null}),t.form.addEventListener("submit",o=>u(null,null,function*(){o.preventDefault(),t.image.wrapper.classList.contains("hide")&&t.image.altText.removeAttribute("required"),R(t.heading,t.text,t.image.altText);let i={date:t.date.value.split("-").reverse().join("/"),heading:t.heading.value,text:t.text.value,edited:!1,id:new Date().valueOf().toString(),imageAlt:t.image.altText.value||"",imageBlob:t.image.fileBlob||null,imageType:t.image.fileType||null};try{yield P(i)}catch(s){console.error("Failed to save entry to IndexedDB",s)}e(i),r&&r(),T(t,n),t.image.fileBlob=null,t.image.fileType=null}))}function z(e){e.addEventListener("keydown",r=>{if(r.key!=="Enter")return;r.preventDefault();let n=window.getSelection();if(!n.rangeCount)return;let t=n.getRangeAt(0);t.deleteContents();let o=document.createElement("br");t.insertNode(o),t.setStartAfter(o),t.setEndAfter(o),n.removeAllRanges(),n.addRange(t)}),e.addEventListener("paste",r=>{r.preventDefault();let t=r.clipboardData.getData("text/plain").split(/\r?\n/),o=window.getSelection(),i=o.getRangeAt(0);i.deleteContents(),t.forEach((s,c)=>{c>0&&(i.insertNode(document.createElement("br")),i.collapse(!1)),i.insertNode(document.createTextNode(s)),i.collapse(!1)}),o.removeAllRanges(),o.addRange(i)})}function v(e,r,n){if(!r||!n||!e)return;let t=r.content.cloneNode(!0),o=t.querySelector("li"),i=t.querySelector("[data-journal-heading]"),s=t.querySelector("[data-journal-text]"),c=t.querySelector("[data-journal-date]"),l=t.querySelector("[data-journal-image-wrapper]");if(p(o,{"data-entry-id":e.id,class:"journal-item"}),i&&(i.textContent=e.heading),s&&(s.textContent=e.text),c&&(c.textContent=e.date),s.innerHTML=e.text.replace(/\n/g,"<br>"),z(s),e.imageBlob){l.innerHTML="",l.classList.add("journal-image-wrapper");let a=document.createElement("img");a.classList.add("lazy-loaded-image","lazy"),a.alt=e.imageAlt||"";let d=URL.createObjectURL(e.imageBlob);a.dataset.src=d,a.src=d,a.onload=()=>{p(a,{width:a.naturalWidth,height:a.naturalHeight})};let m=new MutationObserver(E=>{E.forEach(f=>{f.removedNodes.forEach(y=>{y===a&&(URL.revokeObjectURL(d),m.disconnect())})})});m.observe(l,{childList:!0}),l.appendChild(a);let g=document.createElement("button");g.dataset.removeImageButton="",g.className="remove-image-button",g.textContent="Delete image",l.appendChild(g)}else l.innerHTML="";n.prepend(t)}function C(e,r,n,t){e.toggleAttribute("contenteditable");let o=n.find(i=>i.id===r.dataset.entryId);o.edited=!e.hasAttribute("contenteditable"),o.edited&&(o[t]=e.innerHTML.replace(/<br\s*\/?>/gi,`
`).trim())}function I(e){let r=e.target;r.textContent=r.textContent==="Edit"?"Save":"Edit",r.classList.toggle("edit-button"),r.classList.toggle("save-edit-button")}function M(e,r,n){let t=r.querySelector("[data-journal-text]");C(t,r,n,"text"),I(e)}function $(e,r,n){let t=r.querySelector("[data-journal-heading]");t.addEventListener("keydown",o=>{o.key==="Enter"&&o.preventDefault()}),C(t,r,n,"heading"),I(e)}function b(e){let r=document.getElementById("delete-all-entries");r&&(e.length>1?r.removeAttribute("disabled"):r.setAttribute("disabled",""))}function j(e){let r=[].slice.call(e.querySelectorAll(".lazy-loaded-image.lazy")),n=new IntersectionObserver(function(t){t.forEach(function(o){if(o.isIntersecting){let i=o.target;i.src=i.dataset.src,i.classList.remove("lazy"),n.unobserve(i)}})});r.forEach(function(t){n.observe(t)})}function _({entries:e=[],updateExportButton:r}={}){let n=document.getElementById("journal-form"),t=document.getElementById("journal-item-template"),o=document.createElement("ul"),i=document.getElementById("delete-all-entries");p(o,{class:"journal-list",id:"journal-list"}),n.after(o),e.forEach(c=>v(c,t,o)),b(e),r&&r(),j(o);function s(c){e.push(c),v(c,t,o),j(o),b(e),r&&r();let l=o.firstElementChild;if(l){p(l,{role:"status","aria-live":"polite",tabindex:"-1"}),l.focus(),l.classList.add("focus-highlight"),setTimeout(()=>l.classList.remove("focus-highlight"),2e3);let a=l.nextElementSibling;a&&p(a,{role:null,"aria-live":null,tabindex:null})}}return o.addEventListener("click",c=>u(null,null,function*(){let l=c.target.closest(".journal-item");if(!l)return;let a=e.find(d=>d.id===l.dataset.entryId);if(c.target.matches("[data-button-heading-edit]")){if($(c,l,e),a)try{yield B(a)}catch(d){console.error("Failed to update entry",d)}b(e),r&&r();return}if(c.target.matches("[data-button-text-edit]")){if(M(c,l,e),a)try{yield B(a)}catch(d){console.error("Failed to update entry",d)}b(e),r&&r();return}if(c.target.matches("[data-remove-image-button]")){let d=l.querySelector("[data-journal-image-wrapper]");if(d&&(d.innerHTML=""),a){a.imageBlob=null,a.imageType=null,a.imageAlt="";try{yield B(a)}catch(m){console.error("Failed to remove image in DB",m)}}b(e),r&&r();return}if(c.target.matches("[data-button-journal-delete]")){if(!confirm("Are you sure you want to delete this entry?"))return;l.remove();let d=l.dataset.entryId,m=e.findIndex(g=>g.id===d);m>-1&&e.splice(m,1);try{yield X(d)}catch(g){console.error("Failed to delete entry from DB",g)}b(e),r&&r();return}})),i.addEventListener("click",()=>u(null,null,function*(){if(confirm("Delete ALL entries? This cannot be undone.")){try{yield Y()}catch(c){console.error("Failed to clear DB",c)}e.length=0,o.innerHTML="",b(e),r&&r()}})),{addEntry:s}}function A(e){return String(e).padStart(2,"0")}function te(e){return{dateString:`${e.getUTCFullYear()}-${A(e.getUTCMonth()+1)}-${A(e.getUTCDate())}`,timeString:`${A(e.getUTCHours())}-${A(e.getUTCMinutes())}-${A(e.getUTCSeconds())}`}}function re(e){return u(this,null,function*(){if(!e)return null;let r=yield e.arrayBuffer(),n="",t=new Uint8Array(r),o=t.byteLength;for(let i=0;i<o;i++)n+=String.fromCharCode(t[i]);return btoa(n)})}function J(e="JOURNAL_2025-entries"){return u(this,null,function*(){let r;try{r=yield x()}catch(d){alert("Failed to read entries from the database"),console.error(d);return}if(!Array.isArray(r)||r.length===0){alert("No entries to export");return}let n=[];for(let d of r){let m={id:d.id,date:d.date,heading:d.heading,text:d.text,imageAlt:d.imageAlt||"",edited:d.edited||!1};if(d.imageBlob)try{let g=yield re(d.imageBlob);m.image={mime:d.imageType||"application/octet-stream",data:g}}catch(g){console.warn(`Failed to convert image for entry ${d.id}:`,g),m.image=null}else m.image=null;n.push(m)}let t=JSON.stringify(n,null,2),o=new Date,{dateString:i,timeString:s}=te(o),c=new Blob([t],{type:"application/json"}),l=URL.createObjectURL(c),a=document.createElement("a");a.href=l,a.download=`${e}-${i}_${s}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(l)})}function G(){let e=document.getElementById("export-entries");if(!e)return{};function r(){return u(this,null,function*(){try{let n=yield x();Array.isArray(n)&&n.length>0?e.removeAttribute("disabled"):e.setAttribute("disabled","")}catch(n){console.error("Failed to check entries for export button",n),e.setAttribute("disabled","")}})}return e.addEventListener("click",()=>u(null,null,function*(){yield J()})),r(),{updateButtonState:r}}k();D();F();q();function ne(){return u(this,null,function*(){let e=[];try{e=yield x()}catch(t){console.error("Failed to load entries from IndexedDB",t)}let{updateButtonState:r}=G(),{addEntry:n}=_({entries:e,updateExportButton:r});H({addEntry:n,updateExportButton:r})})}ne();})();
